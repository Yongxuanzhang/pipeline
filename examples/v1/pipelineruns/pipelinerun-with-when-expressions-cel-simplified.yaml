apiVersion: tekton.dev/v1
kind: PipelineRun
metadata:
  generateName: guarded-pr-
spec:
  taskRunTemplate:
    serviceAccountName: 'default'
  pipelineSpec:
    params:
      - name: path
        type: string
        description: The path of the file to be created
      - name: branches
        type: array
        description: The list of branch names
    workspaces:
      - name: source
        description: |
          This workspace is shared among all the pipeline tasks to read/write common resources
    tasks:
      - name: create-file  # when expression using parameter, evaluates to true
        when:
          - cel: "\"$(params.path)\" == \"README.md\""
        workspaces:
          - name: source
            workspace: source
        taskSpec:
          workspaces:
            - name: source
              description: The workspace to create the readme file in
          steps:
            - name: write-new-stuff
              image: ubuntu
              script: 'touch $(workspaces.source.path)/README.md'
      - name: check-file
        params:
          - name: path
            value: "$(params.path)"
        workspaces:
          - name: source
            workspace: source
        runAfter:
          - create-file
        taskSpec:
          params:
            - name: path
          workspaces:
            - name: source
              description: The workspace to check for the file
          results:
            - name: exists
              description: indicates whether the file exists or is missing
          steps:
            - name: check-file
              image: alpine
              script: |
                if test -f $(workspaces.source.path)/$(params.path); then
                  printf yes | tee $(results.exists.path)
                else
                  printf no | tee $(results.exists.path)
                fi
      - name: echo-file-exists  # when expression using task result, evaluates to true
        when:
          - cel: "\"$(tasks.check-file.results.exists)\" in [\"yes\"]"
        taskSpec:
          steps:
            - name: echo
              image: ubuntu
              script: 'echo file exists'
    finally:
      - name: finally-task-should-be-executed  # when expression using execution status, tasks execution status, param, and results
        when:
          - cel: "\"$(tasks.echo-file-exists.status)\" == \"Succeeded\""
          - cel: "\"$(tasks.status)\" ==  \"Succeeded\""
          - cel: "\"$(tasks.check-file.results.exists)\" == \"yes\""
          - cel: "\"$(params.path)\" == \"README.md\""
        taskSpec:
          steps:
            - name: echo
              image: ubuntu
              script: 'echo finally done'
  params:
    - name: path
      value: README.md
    - name: branches
      value:
        - main
        - hotfix
  workspaces:
    - name: source
      volumeClaimTemplate:
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 16Mi
